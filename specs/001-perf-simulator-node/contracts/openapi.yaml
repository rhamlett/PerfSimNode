openapi: 3.0.3
info:
  title: PerfSimNode API
  description: |
    REST API for the Performance Problem Simulator. This API allows you to trigger
    various performance simulations (CPU stress, memory pressure, event loop blocking,
    slow requests, crashes) and observe system metrics.
    
    **Note**: This is a training/educational tool. Do not deploy in production environments.
  version: 1.0.0
  contact:
    name: PerfSimNode
servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://{appname}.azurewebsites.net
    description: Azure App Service
    variables:
      appname:
        default: perfsimnode
        description: Your App Service name

tags:
  - name: Health
    description: Service health and status
  - name: Metrics
    description: System metrics collection
  - name: Simulations
    description: Performance simulation triggers
  - name: Admin
    description: Administration and configuration
  - name: LoadTest
    description: Azure Load Testing endpoint for automated load testing

paths:
  /api/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns service status and basic metrics to verify the application is running.
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/metrics:
    get:
      tags:
        - Metrics
      summary: Get current system metrics
      description: Returns a snapshot of current CPU, memory, event loop, and process metrics.
      operationId: getMetrics
      responses:
        '200':
          description: Current system metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemMetrics'

  /api/simulations:
    get:
      tags:
        - Simulations
      summary: List active simulations
      description: Returns all currently active simulations.
      operationId: listSimulations
      responses:
        '200':
          description: List of active simulations
          content:
            application/json:
              schema:
                type: object
                properties:
                  simulations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Simulation'
                  count:
                    type: integer
                    description: Number of active simulations

  /api/simulations/cpu:
    post:
      tags:
        - Simulations
      summary: Start CPU stress simulation
      description: |
        Triggers a CPU stress simulation that consumes CPU cycles for the specified
        duration at approximately the target load percentage.
        
        Multiple CPU simulations can run concurrently (stacking effects).
      operationId: startCpuStress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CpuStressRequest'
      responses:
        '201':
          description: CPU stress simulation started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationStartedResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/simulations/cpu/{id}:
    delete:
      tags:
        - Simulations
      summary: Stop CPU stress simulation
      description: Stops a running CPU stress simulation by ID.
      operationId: stopCpuStress
      parameters:
        - name: id
          in: path
          required: true
          description: Simulation ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Simulation stopped
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationStoppedResponse'
        '404':
          description: Simulation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/simulations/memory:
    post:
      tags:
        - Simulations
      summary: Start memory pressure simulation
      description: |
        Allocates the specified amount of memory and retains it until explicitly released.
        Returns an allocation ID that can be used to release the memory later.
        
        Multiple memory allocations can exist concurrently.
      operationId: startMemoryPressure
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MemoryPressureRequest'
      responses:
        '201':
          description: Memory allocated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationStartedResponse'
        '400':
          description: Invalid parameters or allocation would exceed limits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/simulations/memory/{id}:
    delete:
      tags:
        - Simulations
      summary: Release memory allocation
      description: Releases a memory allocation by ID, freeing the memory.
      operationId: releaseMemory
      parameters:
        - name: id
          in: path
          required: true
          description: Allocation ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Memory released
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationStoppedResponse'
        '404':
          description: Allocation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/simulations/eventloop:
    post:
      tags:
        - Simulations
      summary: Start event loop blocking simulation
      description: |
        Blocks the Node.js event loop for the specified duration using repeated synchronous
        crypto chunks. Between chunks, a brief yield allows queued I/O to flush so the
        latency chart updates in real-time. The event loop is blocked ~97% of the time.
      operationId: startEventLoopBlocking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventLoopBlockingRequest'
      responses:
        '200':
          description: Event loop blocking completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationCompletedResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/simulations/slow:
    get:
      tags:
        - Simulations
      summary: Slow request simulation
      description: |
        Returns a response after an artificial delay using the specified blocking pattern.
        
        **Blocking Patterns:**
        - `setTimeout` - Non-blocking delay (default). Server remains fully responsive.
        - `libuv` - Saturates libuv thread pool. Affects fs/dns/crypto operations.
        - `worker` - Spawns blocking worker threads. Similar to .NET ThreadPool blocking.
        
        This endpoint is GET to allow easy testing from browsers.
      operationId: slowRequest
      parameters:
        - name: delaySeconds
          in: query
          required: false
          description: Delay in seconds (1-300, default 5)
          schema:
            type: integer
            minimum: 1
            maximum: 300
            default: 5
        - name: blockingPattern
          in: query
          required: false
          description: Blocking pattern to use
          schema:
            type: string
            enum: [setTimeout, libuv, worker]
            default: setTimeout
      responses:
        '200':
          description: Response after delay
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlowRequestResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/simulations/crash/exception:
    post:
      tags:
        - Simulations
      summary: Crash via unhandled exception
      description: |
        Triggers an unhandled exception that will crash the process.
        
        **Warning**: This will terminate the Node.js process. In Azure App Service,
        the process will be automatically restarted.
      operationId: crashException
      responses:
        '202':
          description: Crash initiated (response may not be received)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Crash initiated - process will terminate

  /api/simulations/crash/memory:
    post:
      tags:
        - Simulations
      summary: Crash via memory exhaustion
      description: |
        Triggers memory exhaustion by rapidly allocating memory until OOM.
        
        **Warning**: This will terminate the Node.js process with an out-of-memory error.
      operationId: crashMemory
      responses:
        '202':
          description: Memory exhaustion initiated (response may not be received)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Memory exhaustion initiated - process will terminate

  /api/admin/status:
    get:
      tags:
        - Admin
      summary: Get admin status
      description: Returns detailed status including configuration and all active simulations.
      operationId: getAdminStatus
      responses:
        '200':
          description: Admin status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminStatusResponse'

  /api/admin/events:
    get:
      tags:
        - Admin
      summary: Get event log
      description: Returns recent simulation events from the event log.
      operationId: getEventLog
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of events to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Event log entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/EventLogEntry'
                  count:
                    type: integer

  /api/loadtest:
    get:
      tags:
        - LoadTest
      summary: Execute load test
      description: |
        Executes a load test request with configurable resource consumption.
        Designed for Azure Load Testing integration. Performs sustained CPU work,
        holds memory buffers, and degrades gracefully under concurrent load.
        After 120s of processing, throws random exceptions with 20% probability.
      operationId: executeLoadTest
      parameters:
        - name: workIterations
          in: query
          required: false
          description: CPU spin iterations per work cycle (ms per cycle = workIterations/100)
          schema:
            type: integer
            default: 700
        - name: bufferSizeKb
          in: query
          required: false
          description: Memory buffer held for request duration in KB
          schema:
            type: integer
            default: 100000
        - name: baselineDelayMs
          in: query
          required: false
          description: Minimum request duration in milliseconds
          schema:
            type: integer
            default: 1000
        - name: softLimit
          in: query
          required: false
          description: Concurrent requests before degradation begins
          schema:
            type: integer
            default: 20
        - name: degradationFactor
          in: query
          required: false
          description: Additional delay (ms) per request over soft limit
          schema:
            type: integer
            default: 1000
      responses:
        '200':
          description: Load test completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoadTestResult'
        '500':
          description: Random exception thrown (after 120s threshold)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/loadtest/stats:
    get:
      tags:
        - LoadTest
      summary: Get load test statistics
      description: Returns current load test statistics including concurrent request count without performing work.
      operationId: getLoadTestStats
      responses:
        '200':
          description: Current load test statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoadTestStats'

components:
  schemas:
    LoadTestResult:
      type: object
      properties:
        elapsedMs:
          type: number
          description: Total elapsed time for the request in milliseconds
          example: 157
        concurrentRequestsAtStart:
          type: integer
          description: Number of concurrent requests when this request started
          example: 73
        degradationDelayAppliedMs:
          type: number
          description: Milliseconds of artificial delay applied due to exceeding soft limit
          example: 115
        workIterationsCompleted:
          type: integer
          description: Total ms of CPU work completed (0 if exception thrown)
          example: 1000
        memoryAllocatedBytes:
          type: integer
          description: Bytes of memory allocated (0 if exception thrown)
          example: 5120
        workCompleted:
          type: boolean
          description: Whether the request completed all work successfully
          example: true
        exceptionThrown:
          type: boolean
          description: Whether an exception was thrown during processing
          example: false
        exceptionType:
          type: string
          nullable: true
          description: Type name of exception thrown (null if no exception)
          example: null
        timestamp:
          type: string
          format: date-time
          description: UTC timestamp when the result was generated
    LoadTestStats:
      type: object
      properties:
        currentConcurrentRequests:
          type: integer
          description: Number of requests currently being processed
          example: 127
        totalRequestsProcessed:
          type: integer
          description: Total requests processed since app start
          example: 45230
        totalExceptionsThrown:
          type: integer
          description: Total random exceptions thrown (after 120s timeout)
          example: 23
        averageResponseTimeMs:
          type: number
          description: Average response time in milliseconds
          example: 847.5
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy]
          example: healthy
        timestamp:
          type: string
          format: date-time
        uptime:
          type: number
          description: Process uptime in seconds
        version:
          type: string
          description: Application version

    SystemMetrics:
      type: object
      required:
        - timestamp
        - cpu
        - memory
        - eventLoop
        - process
      properties:
        timestamp:
          type: string
          format: date-time
        cpu:
          $ref: '#/components/schemas/CpuMetrics'
        memory:
          $ref: '#/components/schemas/MemoryMetrics'
        eventLoop:
          $ref: '#/components/schemas/EventLoopMetrics'
        process:
          $ref: '#/components/schemas/ProcessMetrics'

    CpuMetrics:
      type: object
      properties:
        usagePercent:
          type: number
          description: CPU usage percentage (0-100)
        user:
          type: number
          description: User CPU time in microseconds
        system:
          type: number
          description: System CPU time in microseconds

    MemoryMetrics:
      type: object
      properties:
        heapUsedMb:
          type: number
          description: V8 heap memory used in MB
        heapTotalMb:
          type: number
          description: V8 heap memory allocated in MB
        rssMb:
          type: number
          description: Resident Set Size in MB
        externalMb:
          type: number
          description: External memory (C++ objects) in MB

    EventLoopMetrics:
      type: object
      properties:
        lagMs:
          type: number
          description: Current event loop lag in ms
        lagP99Ms:
          type: number
          description: 99th percentile lag in ms
        minMs:
          type: number
          description: Minimum observed lag in ms
        maxMs:
          type: number
          description: Maximum observed lag in ms

    ProcessMetrics:
      type: object
      properties:
        activeHandles:
          type: integer
          description: Number of active handles
        activeRequests:
          type: integer
          description: Number of active libuv requests
        uptime:
          type: number
          description: Process uptime in seconds

    Simulation:
      type: object
      required:
        - id
        - type
        - status
        - startedAt
      properties:
        id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/SimulationType'
        parameters:
          type: object
          description: Type-specific parameters
        status:
          $ref: '#/components/schemas/SimulationStatus'
        startedAt:
          type: string
          format: date-time
        stoppedAt:
          type: string
          format: date-time
          nullable: true
        scheduledEndAt:
          type: string
          format: date-time

    SimulationType:
      type: string
      enum:
        - CPU_STRESS
        - MEMORY_PRESSURE
        - EVENT_LOOP_BLOCKING
        - SLOW_REQUEST
        - CRASH_EXCEPTION
        - CRASH_MEMORY

    SimulationStatus:
      type: string
      enum:
        - ACTIVE
        - COMPLETED
        - STOPPED
        - FAILED

    CpuStressRequest:
      type: object
      required:
        - targetLoadPercent
        - durationSeconds
      properties:
        targetLoadPercent:
          type: integer
          minimum: 1
          maximum: 100
          description: Target CPU load percentage
          example: 80
        durationSeconds:
          type: integer
          minimum: 1
          maximum: 300
          description: Duration in seconds
          example: 30

    MemoryPressureRequest:
      type: object
      required:
        - sizeMb
      properties:
        sizeMb:
          type: integer
          minimum: 1
          maximum: 1000
          description: Memory to allocate in megabytes
          example: 100

    EventLoopBlockingRequest:
      type: object
      required:
        - durationSeconds
      properties:
        durationSeconds:
          type: integer
          minimum: 1
          maximum: 300
          description: Total duration to block in seconds
          example: 5
        chunkMs:
          type: integer
          minimum: 50
          maximum: 2000
          default: 200
          description: Duration of each blocking chunk in milliseconds. Between chunks, queued I/O flushes so the dashboard updates in real-time.
          example: 200

    SimulationStartedResponse:
      type: object
      required:
        - id
        - type
        - message
      properties:
        id:
          type: string
          format: uuid
          description: Simulation ID for tracking/stopping
        type:
          $ref: '#/components/schemas/SimulationType'
        message:
          type: string
          example: CPU stress simulation started
        parameters:
          type: object

    SimulationStoppedResponse:
      type: object
      required:
        - id
        - message
      properties:
        id:
          type: string
          format: uuid
        message:
          type: string
          example: Simulation stopped
        durationMs:
          type: integer
          description: Actual duration before stop

    SimulationCompletedResponse:
      type: object
      required:
        - id
        - type
        - message
        - durationMs
      properties:
        id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/SimulationType'
        message:
          type: string
          example: Event loop blocking completed
        durationMs:
          type: integer
          description: Actual duration

    SlowRequestResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          example: SLOW_REQUEST
        message:
          type: string
          example: Response delayed by 5s using setTimeout pattern
        status:
          type: string
          example: COMPLETED
        requestedDelaySeconds:
          type: integer
        blockingPattern:
          type: string
          enum: [setTimeout, libuv, worker]
          description: The blocking pattern used
        actualDurationMs:
          type: integer
        timestamp:
          type: string
          format: date-time

    EventLogEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        level:
          type: string
          enum: [info, warn, error]
        simulationId:
          type: string
          format: uuid
          nullable: true
        simulationType:
          $ref: '#/components/schemas/SimulationType'
        event:
          type: string
          description: Event type identifier
        message:
          type: string
        details:
          type: object
          nullable: true

    AdminStatusResponse:
      type: object
      properties:
        config:
          type: object
          description: Current configuration
        activeSimulations:
          type: array
          items:
            $ref: '#/components/schemas/Simulation'
        metrics:
          $ref: '#/components/schemas/SystemMetrics'
        connectedClients:
          type: integer
          description: Number of WebSocket clients connected

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details
