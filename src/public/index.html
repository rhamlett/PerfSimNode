<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Problem Simulator - Node Blessed Image (NODE|24-lts)</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <header>
    <h1>ğŸ”¥ Performance Problem Simulator - Node 24 on Linux</h1>
    <span id="sku-badge" class="sku-badge">SKU: Local</span>
    <nav>
      <a href="https://github.com/rhamlett/PerfSimNode" target="_blank" class="nav-link">ğŸ™ GitHub</a>
      <a href="/azure-diagnostics.html" class="nav-link">â˜ï¸ Azure Diagnostics</a>
      <a href="/docs.html" class="nav-link">ğŸ“š Documentation</a>
      <button id="toggle-panel" class="btn-panel-toggle">ğŸ® Controls</button>
    </nav>
    <div id="connection-status" class="status-disconnected">Disconnected</div>
  </header>

  <div class="app-container">
    <main>
      <!-- Compact Metric Tiles -->
      <section id="metrics-section">
        <div class="metrics-tiles">
          <div class="metric-tile cpu">
            <div class="tile-content">
              <div class="tile-icon">âš¡</div>
              <div class="tile-info">
                <span class="tile-label">CPU Usage</span>
                <div class="tile-value"><span id="cpu-value">0.0</span> <span class="tile-unit">%</span></div>
              </div>
            </div>
            <div class="metric-bar"><div class="metric-bar-fill" id="cpu-bar" style="width: 0%;"></div></div>
          </div>
          <div class="metric-tile memory">
            <div class="tile-content">
              <div class="tile-icon">ğŸ“Š</div>
              <div class="tile-info">
                <span class="tile-label">Memory Working Set <span class="info-icon-small" title="Host memory available to the container. On Azure App Service, this may exceed the SKU's advertised RAM due to shared VM resources.">â“˜</span></span>
                <div class="tile-value"><span id="memory-value">0</span> <span class="tile-unit">MB</span> <span id="memory-total" class="tile-subtext">of -- GB</span></div>
              </div>
            </div>
            <div class="metric-bar"><div class="metric-bar-fill" id="memory-bar" style="width: 0%;"></div></div>
          </div>
          <div class="metric-tile eventloop">
            <div class="tile-content">
              <div class="tile-icon">ğŸ§µ</div>
              <div class="tile-info">
                <span class="tile-label">Event Loop Lag</span>
                <div class="tile-value"><span id="eventloop-value">0.0</span> <span class="tile-unit">ms</span></div>
              </div>
            </div>
            <div class="metric-bar"><div class="metric-bar-fill" id="eventloop-bar" style="width: 0%;"></div></div>
          </div>
          <div class="metric-tile latency">
            <div class="tile-content">
              <div class="tile-icon">ğŸ“‹</div>
              <div class="tile-info">
                <span class="tile-label">RSS Memory</span>
                <div class="tile-value"><span id="rss-value">0</span> <span class="tile-unit">MB</span></div>
              </div>
            </div>
            <div class="metric-bar"><div class="metric-bar-fill" id="rss-bar" style="width: 0%;"></div></div>
          </div>
        </div>
      </section>

      <!-- Charts Section -->
      <section id="charts-section">
        <div class="charts-grid">
          <div class="chart-card">
            <h3>ğŸ“ˆ CPU & Memory Over Time</h3>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-color" style="background: #0078d4;"></span> CPU %</span>
              <span class="legend-item"><span class="legend-color" style="background: #107c10;"></span> Memory MB</span>
            </div>
            <canvas id="cpu-memory-chart"></canvas>
          </div>
          <div class="chart-card">
            <h3>ğŸ§µ Event Loop & RSS Memory</h3>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-color" style="background: #8764b8;"></span> Lag (ms)</span>
              <span class="legend-item"><span class="legend-color" style="background: #ffb900;"></span> RSS (MB)</span>
            </div>
            <canvas id="eventloop-chart"></canvas>
          </div>
        </div>
      </section>

      <!-- Request Latency Monitor -->
      <section id="latency-section">
        <div class="latency-card">
          <h3>â±ï¸ Request Latency Monitor <span id="blocked-badge" class="blocked-badge" style="display: none;">ğŸ”´ BLOCKED <span id="blocked-duration"></span></span></h3>
          <p class="latency-description">Measures actual response time to a lightweight probe endpoint. Times include server processing and queue time.</p>
          
          <div class="latency-stats">
            <div class="latency-stat">
              <span class="stat-label">CURRENT</span>
              <span class="stat-value" id="latency-current">0.0ms</span>
            </div>
            <div class="latency-stat">
              <span class="stat-label">AVG (60S)</span>
              <span class="stat-value" id="latency-avg">0.0ms</span>
            </div>
            <div class="latency-stat">
              <span class="stat-label">MAX (60S)</span>
              <span class="stat-value warning" id="latency-max">0.0ms</span>
            </div>
            <div class="latency-stat">
              <span class="stat-label">CRITICAL (>30S)</span>
              <span class="stat-value" id="latency-critical">0</span>
            </div>
          </div>
          <div class="thresholds">
            <span class="threshold-label">Thresholds:</span>
            <span class="threshold good">â— Good (&lt;150ms)</span>
            <span class="threshold degraded">â— Degraded (150ms-1s)</span>
            <span class="threshold severe">â— Severe (&gt;1s)</span>
            <span class="threshold critical">â— Critical (&gt;30s)</span>
          </div>
          <h4>ğŸ“Š Response Latency Over Time</h4>
          <div id="probe-reduced-message" class="probe-reduced-message" style="display: none;"></div>
          <canvas id="latency-chart"></canvas>
        </div>
      </section>

      <!-- Active Simulations -->
      <section id="active-section">
        <div class="active-card">
          <h3>ğŸƒ Active Simulations</h3>
          <div id="active-simulations-list">
            <p class="no-simulations">No active simulations</p>
          </div>
        </div>
      </section>

      <!-- Event Log -->
      <section id="events-section">
        <div class="event-log-card">
          <h3>ğŸ“œ Event Log</h3>
          <div id="event-log" class="event-log"></div>
        </div>
      </section>
    </main>

    <!-- Side Panel for Simulation Controls -->
    <aside id="simulation-panel" class="side-panel">
      <div class="panel-header">
        <h2>âš™ï¸ Simulation Controls</h2>
        <button id="close-panel" class="close-btn">âœ•</button>
      </div>
      <div class="panel-warning">
        âš ï¸ These buttons intentionally cause performance problems!
      </div>
      <div class="panel-content">
        <!-- CPU Stress -->
        <div class="control-section cpu-section">
          <h3>ğŸ”¥ CPU Stress <span class="info-icon" title="On single-core systems (like P0V3), any target >50% will use 1 worker = ~100% CPU. Fine-grained control requires multiple cores. Consider upgrading to P1V3 (2 vCPUs) or higher for precise targeting.">â„¹ï¸</span></h3>
          <p class="control-description">Creates parallel spin loops to max out all CPU cores.</p>
          <form id="cpu-form">
            <label>
              Duration (s):
              <input type="number" name="durationSeconds" value="10" min="1" max="300">
            </label>
            <label>
              Target Load:
              <select name="targetLoadPercent" class="wide-select">
                <option value="25">Low (~25%)</option>
                <option value="50">Medium (~50%)</option>
                <option value="75" selected>High (~75%)</option>
                <option value="100">Maximum (100%)</option>
              </select>
            </label>
            <button type="submit" class="btn-trigger btn-cpu">ğŸ”¥ Trigger High CPU</button>
          </form>
          <div id="cpu-active" class="active-simulations"></div>
        </div>

        <!-- Memory Pressure -->
        <div class="control-section memory-section">
          <h3>ğŸ“Š Memory Pressure</h3>
          <p class="control-description">Allocates pinned memory blocks to increase working set.</p>
          <form id="memory-form">
            <label>
              Size (MB):
              <input type="number" name="sizeMb" value="512" min="1" max="2000">
            </label>
            <div class="btn-group">
              <button type="submit" class="btn-trigger btn-memory">ğŸ“ˆ Allocate</button>
              <button type="button" id="release-all-memory" class="btn-release">ğŸ—‘ï¸ Release</button>
            </div>
          </form>
          <div id="memory-active" class="active-simulations"></div>
        </div>

        <!-- Event Loop Blocking -->
        <div class="control-section eventloop-section">
          <h3>ğŸ§µ Event Loop Blocking</h3>
          <p class="control-description">Blocks Node.js event loop with synchronous crypto operations. Watch the probe dots turn red!</p>
          <div class="eventloop-education">
            <strong>What to observe:</strong>
            <ul>
              <li>"BLOCKED" badge appears in Request Latency Monitor</li>
              <li>Dashboard metrics stop updating during block</li>
              <li>Request latency spikes after server recovers</li>
            </ul>
          </div>
          <form id="eventloop-form">
            <label>
              Block Duration (s):
              <input type="number" name="durationSeconds" value="5" min="1" max="60">
            </label>
            <button type="submit" class="btn-trigger btn-eventloop">ğŸ§µ Block Event Loop</button>
          </form>
          <div id="eventloop-impact" class="eventloop-impact"></div>
        </div>

        <!-- Slow Requests -->
        <div class="control-section slow-section">
          <h3>ğŸŒ Slow Requests</h3>
          <p class="control-description">Generates requests using sync-over-async patterns. Ideal for profiler diagnosis.</p>
          <div class="slow-note">
            âš ï¸ Note: Requests exceeding 30 seconds total time (queue + execution) are flagged as critical
          </div>
          <form id="slow-form">
            <label>
              Request Execution Time (s) <span class="info-icon" title="Time for each request">â“˜</span>:
              <input type="number" name="delaySeconds" value="25" min="1" max="300">
            </label>
            <label>
              Interval (s):
              <input type="number" name="intervalSeconds" value="2" min="1" max="60">
            </label>
            <label>
              Max Requests:
              <input type="number" name="maxRequests" value="10" min="1" max="100">
            </label>
            <div class="btn-group">
              <button type="submit" class="btn-trigger btn-slow">ğŸŒ Start Slow Requests</button>
              <button type="button" id="stop-slow-requests" class="btn-stop">â¬› Stop</button>
            </div>
          </form>
          <div id="slow-status"></div>
        </div>

        <!-- Crash Simulation -->
        <div class="control-section crash-section">
          <h3>ğŸ’¥ Application Crash</h3>
          <p class="control-description">Triggers a fatal crash for crash dump analysis.</p>
          <form id="crash-form">
            <label>
              Crash Type:
              <select name="crashType" class="crash-select">
                <option value="failfast">FailFast (SIGABRT)</option>
                <option value="stackoverflow">Stack Overflow</option>
                <option value="exception" selected>Unhandled Exception</option>
                <option value="oom">Out of Memory</option>
              </select>
            </label>
            <button type="submit" class="btn-danger btn-crash">ğŸ’¥ Trigger Crash</button>
          </form>
          <p class="crash-warning">âš ï¸ This will TERMINATE the app!</p>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    <p>Performance Problem Simulator - Educational Tool for Azure App Service Diagnostics</p>
    <p>Created by <a href="https://speckit.org/" target="_blank">SpecKit</a> in collaboration with <a href="mailto:rhamlett@microsoft.com">Richard Hamlett</a></p>
    <p id="build-info">Build: Loading...</p>
  </footer>

  <script src="/js/socket-client.js"></script>
  <script src="/js/charts.js"></script>
  <script src="/js/dashboard.js"></script>
</body>
</html>
